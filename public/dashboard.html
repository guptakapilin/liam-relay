<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Liam Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{padding:24px;background:#f6f8fa;}
    #dash{display:none}
    .nav-tabs .nav-link.active{background:#0d6efd;color:#fff}
    .card{box-shadow:0 1px 3px rgba(0,0,0,.1)}
    pre,textarea{font-size:.9rem}
    .env-ok{color:#28a745;font-weight:600}
    .env-miss{color:#dc3545;font-weight:600}
  </style>
</head>
<body>
<!-- ‚îÄ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="loginBox" class="container" style="max-width:380px">
  <h3 class="text-center mb-3">üîê Liam Login</h3>
  <input id="user" class="form-control mb-2" placeholder="Username">
  <input id="pass" type="password" class="form-control mb-3" placeholder="Password">
  <button class="btn btn-primary w-100" onclick="login()">Login</button>
  <div id="loginErr" class="text-danger small mt-2"></div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="dash" class="container">
  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#emailTab">Email</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#memTab">Memory</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#launchTab">Launch Action</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#healthTab">Health</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#logsTab">Logs</a></li>
  </ul>

  <div class="tab-content pt-3">

    <!-- EMAIL ------------------------------------------------------------- -->
    <div id="emailTab" class="tab-pane fade show active">
      <div class="card p-3">
        <h5 class="mb-3">Compose Email</h5>
        <input id="emailTo"       class="form-control mb-2" placeholder="Recipient email">
        <input id="emailSubject"  class="form-control mb-2" placeholder="Subject">
        <textarea id="emailBody"  rows="5" class="form-control mb-2" placeholder="Body"></textarea>
        <div class="form-check mb-2">
          <input id="incLink" type="checkbox" class="form-check-input" onchange="linkField.classList.toggle('d-none',!this.checked)">
          <label class="form-check-label" for="incLink">Include optional link</label>
        </div>
        <input id="linkField" class="form-control mb-3 d-none" placeholder="https://...">
        <button class="btn btn-primary" onclick="sendEmail()">Send Email</button>
        <div id="emailStat" class="small mt-2"></div>
      </div>
    </div>

    <!-- MEMORY ------------------------------------------------------------ -->
    <div id="memTab" class="tab-pane fade">
      <div class="row g-3">

        <div class="col-lg-6">
          <div class="card p-3 h-100">
            <h6>Upload Memory ZIP</h6>
            <input type="file" id="memFile" class="form-control mb-2" accept=".zip">
            <button class="btn btn-success" onclick="uploadMem()">Upload</button>
            <div id="memStat" class="small mt-2"></div>

            <h6 class="mt-3">Quick Upload</h6>
            <input type="file" id="quickZip" class="form-control mb-2" accept=".zip">
            <button class="btn btn-success" onclick="quickUpload()">Quick Upload</button>
            <div id="quickZipStat" class="small mt-2"></div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card p-3 h-100">
            <h6>Drive Sync Overview</h6>
            <p id="driveSum" class="small">Loading‚Ä¶</p>
            <button class="btn btn-primary btn-sm" onclick="syncDrive()">Sync Pending ZIPs</button>
            <div id="driveSyncStat" class="small mt-2"></div>

            <h6 class="mt-3">Generate Recall-Link</h6>
            <textarea id="recQuery" rows="2" class="form-control mb-2" placeholder="Query text‚Ä¶"></textarea>
            <button class="btn btn-info btn-sm" onclick="genRecall()">Copy Link</button>
            <div id="recStat" class="small mt-2"></div>
          </div>
        </div>
      </div>

      <h6 class="mt-4">Parsed Files</h6>
      <button class="btn btn-sm btn-secondary mb-2" onclick="loadMem()">Refresh List</button>
      <table class="table table-bordered" id="memTable">
        <thead><tr><th>Date</th><th>Name</th><th>Path</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- LAUNCH ACTION ----------------------------------------------------- -->
    <div id="launchTab" class="tab-pane fade">
      <div class="card p-3">
        <h6>Quick Launch</h6>
        <select id="actionSel" class="form-select mb-2" style="max-width:220px">
          <option value="ping">Ping Server</option>
          <option value="send-email">Send sample email</option>
        </select>
        <button class="btn btn-warning" onclick="runLaunch()">Launch</button>
        <pre id="launchOut" class="small mt-3"></pre>
      </div>
    </div>

    <!-- HEALTH ------------------------------------------------------------ -->
    <div id="healthTab" class="tab-pane fade">
      <button class="btn btn-secondary mb-2" onclick="checkHealth()">Run Health Check</button>
      <pre id="healthOut" class="small"></pre>
    </div>

    <!-- LOGS -------------------------------------------------------------- -->
    <div id="logsTab" class="tab-pane fade">
      <button class="btn btn-secondary mb-2" onclick="loadLogs()">Refresh Logs</button>
      <pre id="logBox" class="small" style="background:#eee;height:300px;overflow:auto"></pre>
    </div>

  </div><!-- /.tab-content -->
</div><!-- /#dash -->

<!-- ‚Äî‚Äî‚Äî Eruda debug console (toggle via gear icon) ‚Äî‚Äî‚Äî -->
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

<script>
const API=''; const KEY='liam_token';

/* ----- helpers ----- */
const hdr=()=>({'Content-Type':'application/json',Authorization:`Bearer ${localStorage.getItem(KEY)}`});

/* ----- login ----- */
async function login(){
  const r=await fetch(API+'/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user:user.value.trim(),pass:pass.value.trim()})});
  const j=await r.json();
  if(r.ok){
    localStorage.setItem(KEY,j.token);
    loginBox.style.display='none'; dash.style.display='block';
    loadMem(); loadDrive(); checkHealth(); loadLogs();
  }else loginErr.textContent=j.error||'Login failed';
}

/* ----- email ----- */
async function sendEmail(){
  const to=emailTo.value.trim(),sub=emailSubject.value.trim(),body=emailBody.value;
  if(!to||!sub||!body){
    emailStat.textContent=`‚ùå Missing: ${!to?'To ':''}${!sub?'Subject ':''}${!body?'Body':''}`; return;
  }
  const payload={to,subject:sub,body,includeLink:incLink.checked,link:linkField.value.trim()};
  const r=await fetch(API+'/send-email',{method:'POST',headers:hdr(),body:JSON.stringify(payload)});
  const j=await r.json();
  emailStat.textContent=j.status||('‚ùå '+j.error);
  if(r.ok){emailTo.value=emailSubject.value=emailBody.value=linkField.value='';incLink.checked=false;linkField.classList.add('d-none');}
}

/* ----- memory upload/list ----- */
async function uploadMem(){
  const f=memFile.files[0]; if(!f){memStat.textContent='Choose ZIP';return;}
  const fd=new FormData();fd.append('file',f);
  const r=await fetch(API+'/upload-memory',{method:'POST',headers:{Authorization:`Bearer ${localStorage.getItem(KEY)}`},body:fd});
  const j=await r.json(); memStat.textContent=j.status==='already_ingested'?`üîÅ ${j.zip} already in memory`:(j.status||j.error);
  if(j.status) loadMem(); memFile.value='';
}
async function quickUpload(){
  const f=quickZip.files[0]; if(!f){quickZipStat.textContent='Choose ZIP';return;}
  const fd=new FormData();fd.append('file',f);
  const r=await fetch(API+'/upload-memory',{method:'POST',headers:{Authorization:`Bearer ${localStorage.getItem(KEY)}`},body:fd});
  const j=await r.json(); quickZipStat.textContent=j.status==='already_ingested'?`üîÅ ${j.zip} already in memory`:(j.status||j.error);
  if(j.status) loadMem(); quickZip.value='';
}
async function loadMem(){
  const r=await fetch(API+'/list-memories',{headers:hdr()});
  const d=await r.json(); const tb=memTable.querySelector('tbody'); tb.innerHTML='';
  if(!Array.isArray(d)){tb.innerHTML='<tr><td colspan="4">Invalid data</td></tr>';return;}
  if(!d.length){tb.innerHTML='<tr><td colspan="4">No files</td></tr>';return;}
  d.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${x.date}</td><td><a href="${x.path}" target="_blank">${x.name}</a></td><td>${x.path}</td><td>${x.status}</td>`;
    tb.appendChild(tr);
  });
}

/* ----- drive sync ----- */
async function loadDrive(){
  const r=await fetch(API+'/drive-status',{headers:hdr()});
  const j=await r.json();
  if(j.error){driveSum.textContent='Drive status error';return;}
  driveSum.textContent=`On Drive: ${j.done.length+j.pending.length}\nAlready: ${j.done.length}\nPending: ${j.pending.length}`;
}
async function syncDrive(){
  driveSyncStat.textContent='‚è≥ Syncing‚Ä¶';
  const r=await fetch(API+'/sync-drive',{method:'POST',headers:hdr()});
  const j=await r.json();
  driveSyncStat.textContent=j.error?('‚ùå '+j.error):`‚úÖ Imported ${j.imported} ZIP(s)`;
  if(!j.error){loadMem();loadDrive();}
}

/* ----- recall link ----- */
async function genRecall(){
  const q=recQuery.value.trim(); if(!q)return;
  const r=await fetch(API+'/generate-recall-link',{method:'POST',headers:hdr(),body:JSON.stringify({query:q})});
  const j=await r.json();
  if(j.link){await navigator.clipboard.writeText(j.link);recStat.textContent='üîó Copied';}
  else      recStat.textContent='‚ùå '+(j.error||'error');
  recQuery.value='';
}

/* ----- launch action ----- */
async function runLaunch(){
  const a=actionSel.value;
  const payload=a==='send-email'
    ?{action:a,data:{to:'test@example.com',subject:'Launch email',body:'Sent via launch',includeLink:false}}
    :{action:a};
  const r=await fetch(API+'/launch-action',{method:'POST',headers:hdr(),body:JSON.stringify(payload)});
  const j=await r.json(); launchOut.textContent=JSON.stringify(j,null,2);
}

/* ----- health & logs ----- */
async function checkHealth(){
  const r=await fetch(API+'/health',{headers:hdr()});
  if(!r.ok){healthOut.textContent='Unauthorized';return;}
  const j=await r.json();
  const ok = k=>j.env && j.env[k];
  healthOut.innerHTML =
    `üß† Brain is live | Uptime: ${j.uptimeMinutes} min\n`+
    Object.keys(j.env||{}).map(k=>`${k}: ${ok(k)?'<span class="env-ok">‚úî</span>':'<span class="env-miss">‚úñ</span>'}`).join('  ');
}
async function loadLogs(){
  const r=await fetch(API+'/cli-logs',{headers:hdr()});
  const j=await r.json();
  logBox.textContent = r.ok ? j.logs.join('\n') : 'Unauthorized';
}

/* auto show */
if(localStorage.getItem(KEY)){
  loginBox.style.display='none'; dash.style.display='block';
  loadMem();loadDrive();checkHealth();loadLogs();
}
</script>
</body>
</html>
