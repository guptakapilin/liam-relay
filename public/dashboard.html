<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Liam Control Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f4f4f4;
    }
    header {
      background: #333;
      color: white;
      padding: 10px 20px;
      text-align: center;
    }
    nav {
      display: flex;
      background: #555;
    }
    nav button {
      flex: 1;
      padding: 10px;
      background: #555;
      color: white;
      border: none;
      cursor: pointer;
    }
    nav button:hover {
      background: #777;
    }
    section {
      padding: 20px;
      display: none;
    }
    section.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>üß† Liam Control Panel</h1>
  </header>
  <nav>
    <button onclick="showTab('email')">Send Email</button>
    <button onclick="showTab('memory')">Memory Upload</button>
    <button onclick="showTab('health')">Health Check</button>
    <button onclick="showTab('logs')">Logs</button>
  </nav>

  <section id="email">
    <h2>üìß Send Email</h2>
    <input id="emailTo" placeholder="To"><br>
    <input id="emailSubject" placeholder="Subject"><br>
    <textarea id="emailBody" rows="5" placeholder="Body"></textarea><br>
    <input type="checkbox" id="includeLink" onclick="toggleLinkField()"> Include optional link<br>
    <input id="linkField" placeholder="Paste optional link" style="display:none;"><br>
    <button onclick="sendEmail()">Send</button>
    <div class="status" id="emailStatus"></div>
  </section>

  <section id="memory">
    <h2>üì¶ Upload Memory</h2>
    <input type="file" id="memoryFile"><br>
    <button onclick="uploadMemory()">Upload</button>
    <div class="status" id="uploadStatus"></div>

    <h3>Quick Upload</h3>
    <input type="file" id="quickZip"><br>
    <button onclick="quickUpload()">Quick Upload</button>
    <div class="status" id="quickZipStatus"></div>

    <button onclick="loadMemories()">üîÅ Refresh List</button>
    <table id="memoryTable">
      <thead>
        <tr><th>Date</th><th>Name</th><th>Path</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="health">
    <h2>ü©∫ System Health</h2>
    <button onclick="checkHealth()">Ping</button>
    <div class="status" id="healthStatus"></div>
  </section>

  <section id="logs">
    <h2>üìú Logs</h2>
    <button onclick="loadLogs()">Refresh Logs</button>
    <pre id="logOutput" style="background:#eee;padding:10px;height:300px;overflow:auto;"></pre>
  </section>

  <script>
    const API = '';
    const TOKEN_KEY = 'liamToken';

    function showTab(id){
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function headers(){
      return { 'Authorization': `Bearer ${localStorage.getItem(TOKEN_KEY)}`, 'Content-Type': 'application/json' };
    }

    function toggleLinkField(){
      const chk = document.getElementById('includeLink');
      document.getElementById('linkField').style.display = chk.checked ? 'block' : 'none';
    }

    async function sendEmail(){
      const to = emailTo.value.trim();
      const subject = emailSubject.value.trim();
      const body = emailBody.value;
      const includeL = includeLink.checked;
      const link = linkField.value.trim();

      if(!to || !subject || !body){
        emailStatus.innerText = '‚ùå Fill To/Subject/Body';
        return;
      }

      const payload = { to, subject, body, includeLink: includeL, link };

      const r = await fetch(API + '/send-email', {
        method: 'POST',
        headers: headers(),
        body: JSON.stringify(payload)
      });

      const j = await r.json();
      emailStatus.innerText = j.status || ('‚ùå ' + j.error);

      if(r.ok){
        emailTo.value = '';
        emailSubject.value = '';
        emailBody.value = '';
        includeLink.checked = false;
        linkField.style.display = 'none';
        linkField.value = '';
      }
    }

    async function uploadMemory(){
      const f = memoryFile.files[0];
      if(!f) return alert('Choose ZIP');
      const fd = new FormData();
      fd.append('file', f);
      const r = await fetch(API + '/upload-memory', {
        method: 'POST',
        headers: { Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}` },
        body: fd
      });
      const j = await r.json();
      uploadStatus.innerText = j.status || j.error;
      if(j.status) loadMemories();
      memoryFile.value = '';
    }

    async function quickUpload(){
      const f = quickZip.files[0];
      if(!f) return alert('Choose ZIP');
      const fd = new FormData();
      fd.append('file', f);
      const r = await fetch(API + '/upload-memory', {
        method: 'POST',
        headers: { Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}` },
        body: fd
      });
      const j = await r.json();
      quickZipStatus.innerText = j.status || j.error;
      if(j.status) loadMemories();
      quickZip.value = '';
    }

    async function loadMemories(){
      const r = await fetch(API + '/list-memories', { headers: headers() });
      const d = await r.json();
      const tbody = memoryTable.querySelector('tbody');
      tbody.innerHTML = '';

      if (!Array.isArray(d)) {
        tbody.innerHTML = '<tr><td colspan="4">‚ùå Invalid memory data</td></tr>';
        return;
      }

      d.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.date}</td><td>${row.name}</td><td>${row.path}</td><td>${row.status}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function checkHealth(){
      const r = await fetch(API + '/health', { headers: headers() });
      const j = await r.json();
      healthStatus.innerText = `üß† Brain is live | Uptime: ${j.uptimeMinutes} min`;
    }

    async function loadLogs(){
      const r = await fetch(API + '/logs', { headers: headers() });
      const t = await r.text();
      logOutput.textContent = t;
    }

    // Auto-show email tab on load
    showTab('email');
  </script>
</body>
</html>
