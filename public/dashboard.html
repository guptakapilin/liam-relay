<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Liam Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { margin-top: 30px; }
    input, textarea, button, select { margin: 5px 0; padding: 8px; width: 100%; max-width: 500px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; max-width: 1000px; }
    td, th { border: 1px solid #ccc; padding: 8px; text-align: left; }
    #loginBox, #mainDashboard { max-width: 600px; margin: auto; }
    #mainDashboard { display: none; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>ğŸ” Liam Login</h2>
    <input id="loginUser" placeholder="Username" />
    <input id="loginPass" type="password" placeholder="Password" />
    <button onclick="doLogin()">Login</button>
    <div id="loginStatus"></div>
  </div>

  <div id="mainDashboard">
    <h2>ğŸ“¨ Send Email</h2>
    <input id="emailTo" placeholder="To (email)" />
    <input id="emailSubject" placeholder="Subject" />
    <textarea id="emailBody" placeholder="Body" rows="5"></textarea>
    <label><input type="checkbox" id="includeLink" onchange="toggleLinkField()"> Include Link</label>
    <input type="text" id="linkField" class="hidden" placeholder="Paste optional link" />
    <button onclick="sendEmail()">Send Email</button>
    <div id="emailStatus"></div>

    <h2>ğŸ§  Upload Memory</h2>
    <input type="file" id="memoryFile" accept=".zip" />
    <button onclick="uploadMemory()">Upload</button>
    <div id="uploadStatus"></div>

    <h2>âš¡ Quick Upload</h2>
    <input type="file" id="quickZip" accept=".zip" />
    <button onclick="quickUpload()">Quick Upload</button>
    <div id="quickZipStatus"></div>

    <h2>ğŸ“‹ Memory Files</h2>
    <button onclick="loadMemories()">ğŸ”„ Refresh List</button>
    <table id="memoryTable">
      <thead>
        <tr><th>Date</th><th>Name</th><th>Path</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>ğŸ§ª Health Check</h2>
    <button onclick="checkHealth()">Run Check</button>
    <pre id="healthStatus"></pre>
  </div>

  <!-- ERUDA DEBUGGER FOR IPAD -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <script>
    const API = '';
    const TOKEN_KEY = 'liamToken';

    function headers() {
      return { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}` };
    }

    function toggleLinkField() {
      const field = document.getElementById('linkField');
      field.classList.toggle('hidden', !document.getElementById('includeLink').checked);
    }

    async function doLogin() {
      const user = document.getElementById('loginUser').value.trim();
      const pass = document.getElementById('loginPass').value.trim();
      const r = await fetch(API + '/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, pass })
      });
      const j = await r.json();
      if (r.ok) {
        localStorage.setItem(TOKEN_KEY, j.token);
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('mainDashboard').style.display = 'block';
        loadMemories();
      } else {
        document.getElementById('loginStatus').innerText = j.error || 'Login failed';
      }
    }

    async function sendEmail() {
      const to = emailTo.value.trim();
      const subject = emailSubject.value.trim();
      const body = emailBody.value;
      const includeL = includeLink.checked;
      const link = linkField.value.trim();
      if (!to || !subject || !body) {
        emailStatus.innerText = 'âŒ Fill To/Subject/Body';
        return;
      }
      const payload = { to, subject, body, includeLink: includeL, link };
      try {
        const r = await fetch(API + '/send-email', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        emailStatus.innerText = j.status || ('âŒ ' + j.error);
        if (r.ok) {
          emailTo.value = ''; emailSubject.value = ''; emailBody.value = '';
          includeLink.checked = false; linkField.value = ''; linkField.classList.add('hidden');
        }
      } catch (e) {
        emailStatus.innerText = 'âŒ Error: ' + e.message;
        console.error(e);
      }
    }

    async function uploadMemory() {
      const f = memoryFile.files[0];
      if (!f) return alert('Choose ZIP');
      const fd = new FormData(); fd.append('file', f);
      const r = await fetch(API + '/upload-memory', {
        method: 'POST',
        headers: { Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}` },
        body: fd
      });
      const j = await r.json();
      uploadStatus.innerText = j.status || j.error;
      if (j.status) loadMemories();
      memoryFile.value = '';
    }

    async function quickUpload() {
      const f = quickZip.files[0];
      if (!f) return alert('Choose ZIP');
      const fd = new FormData(); fd.append('file', f);
      const r = await fetch(API + '/upload-memory', {
        method: 'POST',
        headers: { Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}` },
        body: fd
      });
      const j = await r.json();
      quickZipStatus.innerText = j.status || j.error;
      if (j.status) loadMemories();
      quickZip.value = '';
    }

    async function loadMemories() {
      const r = await fetch(API + '/list-memories', { headers: headers() });
      const d = await r.json();
      const tbody = memoryTable.querySelector('tbody');
      tbody.innerHTML = '';
      d.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.date}</td><td>${row.name}</td><td>${row.path}</td><td>${row.status}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function checkHealth() {
      const r = await fetch(API + '/health', { headers: headers() });
      const j = await r.json();
      healthStatus.innerText = JSON.stringify(j, null, 2);
    }
  </script>
</body>
</html>
